import requests
import pandas as pd

# Google Places API Key（請確保 API Key 沒有空格）
API_KEY = "AIzaSyCSjgDp4YRLipBUWzKnY0-jPkQSsriAu1w"

# 台北捷運站座標
taipei_mrt_stations = {
    # 紅線
    "象山": (25.03283, 121.569576),
    "台北101/世貿": (25.033102, 121.563292),
    "信義安和": (25.033326, 121.553526),
    "大安": (25.032943, 121.543551),
    "大安森林公園": (25.033396, 121.534882),
    "東門": (25.033847, 121.528739),
    "中正紀念堂": (25.032729, 121.51827),
    "台大醫院": (25.041256, 121.51604),
    "台北車站": (25.046255, 121.517532),
    "中山": (25.052685, 121.520392),
    "雙連": (25.057805, 121.520627),
    "民權西路": (25.062905, 121.51932),
    "圓山": (25.071353, 121.520118),
    "劍潭": (25.084873, 121.525078),
    "士林": (25.093535, 121.52623),
    "芝山": (25.10306, 121.522514),
    "明德": (25.109721, 121.518848),
    "石牌": (25.114523, 121.515559),
    "唭哩岸": (25.120872, 121.506252),
    "奇岩": (25.125491, 121.501132),
    "北投": (25.131841, 121.498633),
    "新北投": (25.136933, 121.50253),
    "復興崗": (25.137474, 121.485444),
    "忠義": (25.130969, 121.47341),
    "關渡": (25.125633, 121.467102),
    "竹圍": (25.13694, 121.459479),
    "紅樹林": (25.154042, 121.458872),
    "淡水": (25.167818, 121.445561),
    # 藍線
    "頂埔": (24.96012, 121.4205),
    "永寧": (24.966726, 121.436072),
    "土城": (24.973094, 121.444362),
    "海山": (24.985339, 121.448786),
    "亞東醫院": (24.998037, 121.452514),
    "府中": (25.008619, 121.459409),
    "板橋": (25.013618, 121.462302),
    "新埔": (25.023738, 121.468361),
    "江子翠": (25.03001, 121.47239),
    "龍山寺": (25.03528, 121.499826),
    "西門": (25.04209, 121.508303),
    "善導寺": (25.044823, 121.523208),
    "忠孝新生": (25.042356, 121.532905),
    "忠孝復興": (25.041629, 121.543767),
    "忠孝敦化": (25.041478, 121.551098),
    "國父紀念館": (25.041349, 121.557802),
    "市政府": (25.041171, 121.565228),
    "永春": (25.040859, 121.576293),
    "後山埤": (25.045055, 121.582522),
    "昆陽": (25.050461, 121.593268),
    "南港": (25.052116, 121.606686)
}

def search_restaurants(station, lat, lng, keyword="美食", radius=500):
    """搜尋捷運站周邊的美食餐廳，返回 捷運站、商家 ID 和 商家名稱"""
    url = "https://maps.googleapis.com/maps/api/place/nearbysearch/json"
    params = {
        "location": f"{lat},{lng}",
        "radius": radius,
        "keyword": keyword,
        "type": "restaurant",
        "key": API_KEY
    }
    response = requests.get(url, params=params)
    
    # 檢查 API 是否成功返回結果
    data = response.json()
    if "error_message" in data:
        print(f"⚠️ Google Places API 錯誤：{data['error_message']}")
        return []
    
    return [{"捷運站": station, "商家ID": r["place_id"], "商家名稱": r["name"]} for r in data.get("results", [])]

# 存放結果
restaurants_data = []

for station, (lat, lng) in taipei_mrt_stations.items():
    print(f"📍 正在抓取 {station} 附近的餐廳...")
    restaurants = search_restaurants(station, lat, lng)
    restaurants_data.extend(restaurants)

# 儲存為 CSV（包含 捷運站、商家ID 和 商家名稱）
df = pd.DataFrame(restaurants_data)
df.to_csv("taipei_mrt_businesses.csv", index=False, encoding="utf-8-sig")

print("✅ 爬取完成！已儲存 taipei_mrt_businesses.csv")
